<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .loader {
        border-top-color: #3498db;
        -webkit-animation: spinner 1.5s linear infinite;
        animation: spinner 1.5s linear infinite;
      }
      @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-4 flex flex-col items-center">

    <div class="max-w-md w-full bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="bg-blue-600 p-4 text-center">
        <h1 class="text-white text-xl font-bold">ååˆºAIè§£æã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h1>
        <p class="text-blue-100 text-sm">Gemini 3.0 Flash</p>
      </div>

      <div class="p-6 space-y-6">
        
        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">è§£æãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</label>
          <div class="grid grid-cols-2 gap-2">
            <button id="btn-merge" onclick="setMode('merge')" class="p-3 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-bold text-center transition-all">
              ğŸ”„ è£è¡¨çµ±åˆ<br><span class="text-xs font-normal">2æšã‚’1ä»¶ã«åˆä½“</span>
            </button>
            <button id="btn-multi" onclick="setMode('multi')" class="p-3 border-2 border-gray-200 text-gray-500 rounded-lg text-center hover:bg-gray-50 transition-all">
              ğŸ“š è¤‡æ•°ä¸€æ‹¬<br><span class="text-xs font-normal">ã¾ã¨ã‚ã¦ãƒªã‚¹ãƒˆåŒ–</span>
            </button>
          </div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors relative">
          <!-- onchangeã‚’å¤‰æ›´ï¼šè¿½åŠ é¸æŠã«å¯¾å¿œ -->
          <input type="file" id="fileInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
          
          <div id="upload-placeholder">
            <div class="text-4xl mb-2">ğŸ“·</div>
            <p class="text-gray-500 text-sm">ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•<br>ã¾ãŸã¯ç”»åƒã‚’è¿½åŠ </p>
          </div>
          
          <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºï¼‰ -->
          <div id="preview-area" class="hidden grid grid-cols-2 gap-3 mt-2 pointer-events-none relative z-10">
            <!-- JSã§ç”»åƒãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
          </div>
        </div>
        <p class="text-xs text-gray-400 text-center">â€» ç¶šã‘ã¦é¸æŠãƒ»æ’®å½±ã™ã‚‹ã“ã¨ã§ç”»åƒã‚’è¿½åŠ ã§ãã¾ã™</p>

        <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
        <button id="submitBtn" onclick="uploadAndAnalyze()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400 transition-all">
          è§£æã‚’é–‹å§‹ã™ã‚‹
        </button>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div id="status" class="hidden text-center p-4 rounded-lg bg-gray-100">
          <div id="spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mb-2 mx-auto"></div>
          <p id="status-text" class="text-gray-700 text-sm">ç”»åƒã‚’è§£æä¸­...</p>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div id="result-area" class="hidden space-y-2">
          <h3 class="font-bold text-gray-700">è§£æçµæœ</h3>
          <div id="result-list" class="text-sm bg-gray-50 p-2 rounded max-h-40 overflow-y-auto"></div>
          <p class="text-xs text-green-600 text-center">âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸ</p>
        </div>

      </div>
    </div>

    <script>
      let currentMode = 'merge';
      let selectedFiles = []; // é¸æŠã•ã‚ŒãŸå…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã™ã‚‹é…åˆ—

      function setMode(mode) {
        currentMode = mode;
        const btnMerge = document.getElementById('btn-merge');
        const btnMulti = document.getElementById('btn-multi');
        
        if (mode === 'merge') {
          btnMerge.className = "p-3 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-bold text-center transition-all";
          btnMulti.className = "p-3 border-2 border-gray-200 text-gray-500 rounded-lg text-center hover:bg-gray-50 transition-all";
        } else {
          btnMerge.className = "p-3 border-2 border-gray-200 text-gray-500 rounded-lg text-center hover:bg-gray-50 transition-all";
          btnMulti.className = "p-3 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-bold text-center transition-all";
        }
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠãƒ»æ’®å½±ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆè¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
      function handleFileSelect(input) {
        if (input.files && input.files.length > 0) {
          const newFiles = Array.from(input.files);
          // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã«è¿½åŠ 
          selectedFiles = selectedFiles.concat(newFiles);
          
          updatePreview();
          
          // inputã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸ã¹ã‚‹ã‚ˆã†ã«ï¼†é€£ç¶šé¸æŠå¯èƒ½ã«ã™ã‚‹
          input.value = '';
        }
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã®æ›´æ–°
      function updatePreview() {
        const placeholder = document.getElementById('upload-placeholder');
        const previewArea = document.getElementById('preview-area');
        
        previewArea.innerHTML = ''; // ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦å†æç”»

        if (selectedFiles.length > 0) {
          placeholder.classList.add('hidden');
          previewArea.classList.remove('hidden');
          
          selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠ
              const div = document.createElement('div');
              div.className = 'relative group pointer-events-auto'; // pointer-events-autoã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã‚‹ã‚ˆã†ã«
              
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'w-full h-24 object-cover rounded-lg shadow border border-gray-200';
              
              // å‰Šé™¤ãƒœã‚¿ãƒ³ (Ã—)
              const removeBtn = document.createElement('button');
              removeBtn.innerHTML = 'Ã—';
              removeBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shadow-md hover:bg-red-600 transition-colors z-20';
              removeBtn.onclick = (ev) => {
                ev.preventDefault(); // è¦ªã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç­‰ã‚’é˜²æ­¢
                removeFile(index);
              };

              div.appendChild(img);
              div.appendChild(removeBtn);
              previewArea.appendChild(div);
            };
            reader.readAsDataURL(file);
          });
        } else {
          // ç”»åƒãŒ0æšã«ãªã£ãŸã‚‰ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
          placeholder.classList.remove('hidden');
          previewArea.classList.add('hidden');
        }
      }

      // ç”»åƒã®å‰Šé™¤å‡¦ç†
      function removeFile(index) {
        selectedFiles.splice(index, 1); // é…åˆ—ã‹ã‚‰å‰Šé™¤
        updatePreview(); // å†æç”»
      }

      async function uploadAndAnalyze() {
        if (selectedFiles.length === 0) {
          alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }
        if (currentMode === 'merge' && selectedFiles.length !== 2) {
          if(!confirm("è£è¡¨çµ±åˆãƒ¢ãƒ¼ãƒ‰ã§ã™ãŒã€ç”»åƒãŒ2æšã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨ " + selectedFiles.length + " æšï¼‰ã€‚\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
        }

        // UIæ›´æ–°
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('status').classList.remove('hidden');
        document.getElementById('result-area').classList.add('hidden');
        document.getElementById('status-text').innerText = "ç”»åƒã‚’åœ§ç¸®ãƒ»é€ä¿¡ä¸­...";

        try {
          // ç”»åƒã‚’Base64åŒ– & ãƒªã‚µã‚¤ã‚º
          const processedImages = await Promise.all(selectedFiles.map(file => processFile(file)));

          document.getElementById('status-text').innerText = "AIãŒè§£æä¸­... (Gemini 3.0)";

          // ã‚µãƒ¼ãƒãƒ¼å´å‡¦ç†å‘¼ã³å‡ºã—
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .analyzeFromWeb({
              mode: currentMode,
              images: processedImages
            });

        } catch (e) {
          onFailure(e);
        }
      }

      // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦Base64ã‚’è¿”ã™é–¢æ•°
      function processFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              const MAX_WIDTH = 1600;
              let width = img.width;
              let height = img.height;

              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }

              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);

              const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
              resolve({
                mimeType: 'image/jpeg',
                data: dataUrl.split(',')[1]
              });
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      function onSuccess(res) {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('status').classList.add('hidden');
        document.getElementById('result-area').classList.remove('hidden');

        const list = document.getElementById('result-list');
        list.innerHTML = '';
        
        res.data.forEach(item => {
          const div = document.createElement('div');
          div.className = "border-b border-gray-200 py-1";
          div.innerHTML = `<b>${item.companyName || 'ä¼šç¤¾åä¸æ˜'}</b><br>${item.fullName || 'æ°åä¸æ˜'}`;
          list.appendChild(div);
        });

        // æˆåŠŸã—ãŸã‚‰ç”»åƒãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã‹ã©ã†ã‹ã¯ãŠå¥½ã¿ã§ã™ãŒã€ä»Šå›ã¯æ®‹ã—ã¦ãŠãã¾ã™ï¼ˆé€£ç¶šæŠ•ç¨¿ã—ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
        // selectedFiles = [];
        // updatePreview();
      }

      function onFailure(err) {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('status').classList.add('hidden');
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
      }
    </script>
  </body>
</html>