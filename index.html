<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .loader {
        border-top-color: #3498db;
        -webkit-animation: spinner 1.5s linear infinite;
        animation: spinner 1.5s linear infinite;
      }
      @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .sfa-card {
        transition: all 0.3s ease;
      }
      .sfa-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 600;
      }
      .fade-in {
        animation: fadeIn 0.4s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to   { opacity: 1; transform: translateY(0); }
      }
      .tab-active {
        border-bottom: 3px solid #2563eb;
        color: #2563eb;
        font-weight: 700;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-4 flex flex-col items-center">

    <div class="max-w-lg w-full">

      <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
      <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-t-xl p-5 text-center shadow-lg">
        <h1 class="text-white text-xl font-bold tracking-wide">ååˆºAIè§£æ + SFA</h1>
        <p class="text-blue-100 text-xs mt-1">Gemini 2.0 Flash / Sales Force Automation</p>
      </div>

      <!-- ===== ã‚¿ãƒ–åˆ‡æ›¿ ===== -->
      <div class="bg-white flex border-b">
        <button onclick="switchTab('scan')" id="tab-scan" class="flex-1 py-3 text-sm text-center tab-active">
          ååˆºã‚¹ã‚­ãƒ£ãƒ³
        </button>
        <button onclick="switchTab('result')" id="tab-result" class="flex-1 py-3 text-sm text-center text-gray-500 hover:text-gray-700">
          SFAçµæœ
        </button>
      </div>

      <!-- ===== ã‚¿ãƒ–: ååˆºã‚¹ã‚­ãƒ£ãƒ³ ===== -->
      <div id="panel-scan" class="bg-white rounded-b-xl shadow-lg overflow-hidden">
        <div class="p-6 space-y-5">

          <!-- æ‹…å½“è€…å -->
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">æ‹…å½“è€…åï¼ˆã‚ãªãŸã®åå‰ï¼‰</label>
            <input type="text" id="staffNameInput" placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-transparent">
          </div>

          <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-2">è§£æãƒ¢ãƒ¼ãƒ‰</label>
            <div class="grid grid-cols-2 gap-2">
              <button id="btn-merge" onclick="setMode('merge')" class="p-3 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-bold text-center text-sm transition-all">
                è£è¡¨çµ±åˆ<br><span class="text-xs font-normal">2æšã‚’1ä»¶ã«</span>
              </button>
              <button id="btn-multi" onclick="setMode('multi')" class="p-3 border-2 border-gray-200 text-gray-500 rounded-lg text-center text-sm hover:bg-gray-50 transition-all">
                è¤‡æ•°ä¸€æ‹¬<br><span class="text-xs font-normal">ã¾ã¨ã‚ã¦è§£æ</span>
              </button>
            </div>
          </div>

          <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors relative">
            <input type="file" id="fileInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
            <div id="upload-placeholder">
              <div class="text-4xl mb-2">ğŸ“·</div>
              <p class="text-gray-500 text-sm">ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•<br>ã¾ãŸã¯ç”»åƒã‚’è¿½åŠ </p>
            </div>
            <div id="preview-area" class="hidden grid grid-cols-2 gap-3 mt-2 pointer-events-none relative z-10"></div>
          </div>
          <p class="text-xs text-gray-400 text-center">ç”»åƒã‚’è¿½åŠ é¸æŠã§ãã¾ã™</p>

          <!-- SFAæ©Ÿèƒ½ãƒˆã‚°ãƒ« -->
          <div class="bg-indigo-50 rounded-lg p-3 space-y-2">
            <p class="text-xs font-bold text-indigo-700">SFAè‡ªå‹•åˆ†æï¼ˆååˆºç™»éŒ²ã¨åŒæ™‚ã«å®Ÿè¡Œï¼‰</p>
            <label class="flex items-center gap-2 text-xs text-gray-700">
              <input type="checkbox" id="chk-sns" checked class="rounded text-blue-600"> SNSãƒ»Webæ¤œç´¢URLã‚’ç”Ÿæˆ
            </label>
            <label class="flex items-center gap-2 text-xs text-gray-700">
              <input type="checkbox" id="chk-industry" checked class="rounded text-blue-600"> æ¥­ç•Œåˆ†æãƒ»èª²é¡Œä»®èª¬ã‚’ç”Ÿæˆ
            </label>
            <label class="flex items-center gap-2 text-xs text-gray-700">
              <input type="checkbox" id="chk-dup" checked class="rounded text-blue-600"> é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆç¤¾å†…æ¥è§¦å±¥æ­´ï¼‰
            </label>
            <label class="flex items-center gap-2 text-xs text-gray-700">
              <input type="checkbox" id="chk-similar" checked class="rounded text-blue-600"> é¡ä¼¼ä¼æ¥­ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€™è£œ
            </label>
          </div>

          <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
          <button id="submitBtn" onclick="uploadAndAnalyze()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-lg shadow-md hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-400 transition-all">
            è§£æã‚’é–‹å§‹ã™ã‚‹
          </button>

          <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
          <div id="status" class="hidden text-center p-4 rounded-lg bg-gray-100">
            <div id="spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mb-2 mx-auto"></div>
            <p id="status-text" class="text-gray-700 text-sm">ç”»åƒã‚’è§£æä¸­...</p>
            <div id="progress-bar" class="mt-2 hidden">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-fill" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
              <p id="progress-text" class="text-xs text-gray-500 mt-1"></p>
            </div>
          </div>

        </div>
      </div>

      <!-- ===== ã‚¿ãƒ–: SFAçµæœ ===== -->
      <div id="panel-result" class="bg-white rounded-b-xl shadow-lg overflow-hidden hidden">
        <div class="p-4 space-y-4">

          <div id="no-result" class="text-center text-gray-400 py-8">
            <div class="text-4xl mb-2">ğŸ“Š</div>
            <p class="text-sm">ã¾ã è§£æçµæœãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>

          <div id="sfa-results" class="hidden space-y-4 fade-in">
            <!-- JS ã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>

        </div>
      </div>

    </div>

    <!-- ========================================= -->
    <!-- JavaScript -->
    <!-- ========================================= -->
    <script>
      let currentMode = 'merge';
      let selectedFiles = [];
      let latestResults = [];

      // â”€â”€ ã‚¿ãƒ–åˆ‡æ›¿ â”€â”€
      function switchTab(tab) {
        document.getElementById('panel-scan').classList.toggle('hidden', tab !== 'scan');
        document.getElementById('panel-result').classList.toggle('hidden', tab !== 'result');
        document.getElementById('tab-scan').classList.toggle('tab-active', tab === 'scan');
        document.getElementById('tab-result').classList.toggle('tab-active', tab === 'result');
        document.getElementById('tab-scan').classList.toggle('text-gray-500', tab !== 'scan');
        document.getElementById('tab-result').classList.toggle('text-gray-500', tab !== 'result');
      }

      // â”€â”€ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ â”€â”€
      function setMode(mode) {
        currentMode = mode;
        const btnMerge = document.getElementById('btn-merge');
        const btnMulti = document.getElementById('btn-multi');
        if (mode === 'merge') {
          btnMerge.className = "p-3 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-bold text-center text-sm transition-all";
          btnMulti.className = "p-3 border-2 border-gray-200 text-gray-500 rounded-lg text-center text-sm hover:bg-gray-50 transition-all";
        } else {
          btnMerge.className = "p-3 border-2 border-gray-200 text-gray-500 rounded-lg text-center text-sm hover:bg-gray-50 transition-all";
          btnMulti.className = "p-3 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-bold text-center text-sm transition-all";
        }
      }

      // â”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â”€â”€
      function handleFileSelect(input) {
        if (input.files && input.files.length > 0) {
          selectedFiles = selectedFiles.concat(Array.from(input.files));
          updatePreview();
          input.value = '';
        }
      }

      function updatePreview() {
        const placeholder = document.getElementById('upload-placeholder');
        const previewArea = document.getElementById('preview-area');
        previewArea.innerHTML = '';

        if (selectedFiles.length > 0) {
          placeholder.classList.add('hidden');
          previewArea.classList.remove('hidden');
          selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const div = document.createElement('div');
              div.className = 'relative group pointer-events-auto';
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'w-full h-24 object-cover rounded-lg shadow border border-gray-200';
              const removeBtn = document.createElement('button');
              removeBtn.innerHTML = '&times;';
              removeBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shadow-md hover:bg-red-600 z-20';
              removeBtn.onclick = (ev) => { ev.preventDefault(); removeFile(index); };
              div.appendChild(img);
              div.appendChild(removeBtn);
              previewArea.appendChild(div);
            };
            reader.readAsDataURL(file);
          });
        } else {
          placeholder.classList.remove('hidden');
          previewArea.classList.add('hidden');
        }
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        updatePreview();
      }

      // â”€â”€ ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ â”€â”€
      async function uploadAndAnalyze() {
        if (selectedFiles.length === 0) { alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        if (currentMode === 'merge' && selectedFiles.length !== 2) {
          if(!confirm("è£è¡¨çµ±åˆãƒ¢ãƒ¼ãƒ‰ã§ã™ãŒç”»åƒãŒ2æšã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨ " + selectedFiles.length + " æšï¼‰ã€‚\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        showStatus('ç”»åƒã‚’åœ§ç¸®ãƒ»é€ä¿¡ä¸­...', 10);

        try {
          const processedImages = await Promise.all(selectedFiles.map(file => processFile(file)));
          showStatus('AIãŒååˆºã‚’è§£æä¸­...', 30);

          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .analyzeFromWeb({
              mode: currentMode,
              images: processedImages,
              staffName: document.getElementById('staffNameInput').value.trim(),
            });

        } catch (e) {
          onFailure(e);
        }
      }

      function processFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              const MAX_WIDTH = 1600;
              let width = img.width, height = img.height;
              if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
              canvas.width = width; canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
              resolve({ mimeType: 'image/jpeg', data: dataUrl.split(',')[1] });
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º â”€â”€
      function showStatus(text, progress) {
        document.getElementById('status').classList.remove('hidden');
        document.getElementById('status-text').innerText = text;
        if (progress !== undefined) {
          document.getElementById('progress-bar').classList.remove('hidden');
          document.getElementById('progress-fill').style.width = progress + '%';
          document.getElementById('progress-text').innerText = progress + '% å®Œäº†';
        }
      }
      function hideStatus() {
        document.getElementById('status').classList.add('hidden');
        document.getElementById('progress-bar').classList.add('hidden');
      }

      // â”€â”€ æˆåŠŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ â”€â”€
      function onSuccess(res) {
        document.getElementById('submitBtn').disabled = false;
        hideStatus();
        latestResults = res.data;
        renderSfaResults(res.data);
        switchTab('result');
      }

      // â”€â”€ å¤±æ•—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ â”€â”€
      function onFailure(err) {
        document.getElementById('submitBtn').disabled = false;
        hideStatus();
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + (err.message || err));
      }

      // â”€â”€ SFAçµæœãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â”€â”€
      function renderSfaResults(data) {
        const container = document.getElementById('sfa-results');
        const noResult  = document.getElementById('no-result');

        if (!data || data.length === 0) {
          noResult.classList.remove('hidden');
          container.classList.add('hidden');
          return;
        }

        noResult.classList.add('hidden');
        container.classList.remove('hidden');
        container.innerHTML = '';

        data.forEach((item, idx) => {
          const card = document.createElement('div');
          card.className = 'sfa-card bg-white border rounded-xl p-4 space-y-3 fade-in';
          card.style.animationDelay = (idx * 0.1) + 's';

          // ãƒ˜ãƒƒãƒ€ãƒ¼ (ä¼šç¤¾å + æ°å)
          let html = `
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold text-gray-800">${esc(item.companyName || 'ä¼šç¤¾åä¸æ˜')}</h3>
                <p class="text-sm text-gray-600">${esc(item.fullName || '')} ${esc(item.title || '')}</p>
              </div>
              <span class="badge bg-blue-100 text-blue-700">#${idx + 1}</span>
            </div>`;

          // é‡è¤‡ã‚¢ãƒ©ãƒ¼ãƒˆ
          if (item.duplicateAlert) {
            html += `
              <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
                <p class="text-xs font-bold text-yellow-800">é‡è¤‡æ¤œçŸ¥</p>
                <p class="text-xs text-yellow-700 mt-1">${esc(item.duplicateAlert)}</p>
              </div>`;
          }

          // æ¥­ç•Œåˆ†æ
          if (item.industry || item.trends) {
            html += `
              <div class="bg-indigo-50 rounded-lg p-3">
                <p class="text-xs font-bold text-indigo-700 mb-1">æ¥­ç•Œ: ${esc(item.industry)}</p>
                <details class="text-xs text-gray-700">
                  <summary class="cursor-pointer text-indigo-600 font-medium">ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»èª²é¡Œã‚’è¡¨ç¤º</summary>
                  <div class="mt-2 space-y-2">
                    <div><p class="font-semibold">ãƒˆãƒ¬ãƒ³ãƒ‰:</p><p class="whitespace-pre-wrap">${esc(item.trends)}</p></div>
                    <div><p class="font-semibold">æƒ³å®šèª²é¡Œ:</p><p class="whitespace-pre-wrap">${esc(item.challenges)}</p></div>
                  </div>
                </details>
              </div>`;
          }

          // é¡ä¼¼ä¼æ¥­
          if (item.similarCompanies) {
            html += `
              <div class="bg-green-50 rounded-lg p-3">
                <p class="text-xs font-bold text-green-700 mb-1">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€™è£œä¼æ¥­</p>
                <p class="text-xs text-gray-700 whitespace-pre-wrap">${esc(item.similarCompanies)}</p>
              </div>`;
          }

          // ä¿å­˜å®Œäº†
          html += `<p class="text-xs text-green-600 text-center">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸ</p>`;

          card.innerHTML = html;
          container.appendChild(card);
        });
      }

      // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      function esc(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
